{% extends "people/profile_base.html" %}
{% load static %}
{% load friendly_loader %}
{% friendly_load i18n avatar_tags relationship_tags activity_tags %}
{% load pagination_tags %}
{% load bootstrap_tags %}

{% block title %} {% trans "Profile of " %}{{ profile.first_name|default:profile.username }}{% endblock %}

{% block head %}
  {% if TWITTER_CARD %}
    {% include "people/_profile_twittercard.html" %}
  {% endif %}
  {% if OPENGRAPH_ENABLED %}
    {% include "people/_profile_opengraph.html" %}
  {% endif %}
  {{ block.super }}
{% endblock %}

{% block body_class %}people explore{% endblock %}

{% block body %}
<div id="user_messages">
  {% verbatim %}
    <div class="alert alert-block announcement alert-warning" ng-repeat="message in messages" ng-cloak>
        <a type="button" class="close" data-dismiss="alert" data-dismiss-url="#" href="#">×</a>
        <p class="{{ message.tags }}">{{ message.message }}</p>
    </div>
  {% endverbatim %}
</div>
<div class="page-header">
  <h2 class="page-title">{{ profile.name_long }}</h2>
</div>

<div class="col-xs-3 col-md-2 profile-image">
  {% avatar profile 240 %}
  {% if user == profile %}
  <p style="padding-top: 5px"><a class="btn btn-primary btn-block" href="#change_avatar" data-toggle="modal">{% trans "Change your avatar" %}</a></p>
  {% endif %}
</div>

<!-- Change Avatar Modal {% url 'avatar_change' %} -->
<div id="change_avatar" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h4 class="modal-title">{% trans 'Choose Your Avatar' %}</h4>
        </div>
          <div class="modal-body">
            <form enctype="multipart/form-data" method="POST" action="{% url 'avatar_add' %}">
              <label for="id_avatar">Upload a new Avatar:</label>
              <input id="id_avatar" name="avatar" type="file">
              <p>{% csrf_token %}<input id="avatar_file" type="submit" class="btn btn-primary" style="visibility: hidden" value="{% trans "Upload New Image" %}" /></p>
            </form>
            <p><b>Choose from previous:</b></p>
            <form method="POST" action="{% url 'avatar_change' %}">
              {% for avi in avatars %}
              <span class="avatar_img" id="avatar_{{ avi.avatar.id }}">{{ avi.img }}</span>
              <input id="avatar_choice_{{ avi.avatar.id }}" name="choice" type="radio" value="{{ avi.avatar.id }}" style="display: none">
              {% endfor %}
              <p>{% csrf_token %}<input id="avatar_swap" type="submit" class="btn btn-primary" style="display: none" value="{% trans "Choose new Default" %}" /></p>
            </form>
            <form method="POST" action="{% url 'avatar_delete' %}">
              {% for avi in avatars %}
              <input id="avatar_delete_{{ avi.avatar.id }}" name="choices" type="checkbox" value="{{ avi.avatar.id }}" style="display: none">
              {% endfor %}
              <p>{% csrf_token %}<input id="avatar_delete" type="submit" class="btn btn-primary" style="display: none"/></p>
            </form>
            <input id="delete_avatar_btn" class="btn btn-danger" value="{% trans "Delete Avatar" %}" disabled/>
          </div>
          <div class="modal-footer">
              <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans 'Cancel' %}</button>
              <button id="avatar_change_btn" class="btn btn-primary" disabled>{% trans 'Confirm' %}</button>
          </div>
      </div>
    </div>
</div>

<div class="col-xs-9 col-md-7 profile-details">

{% if user.is_authenticated %}
{% if user == profile %}
  {% for group in profile.group_list_all %}
  <div ng-if="group.logo != ''" class="col-xs-1 pull-right group-logo">
    <!-- <a href="{{ group.get_absolute_url }}" ><img src="/uploaded/{{ group.logo }}" alt="{{ group.title }}" /></a> -->
    
    {% if group.logo %}
    	<a href="{{ group.get_absolute_url }}" ><img src="/uploaded/{{ group.logo }}" alt="{{ group.title }}" /></a>
    {% else %}
    	<a href="{{ group.get_absolute_url }}" ><i class="fa fa-group fa-3x" title="{{ group.title }}"></i></a>
    {% endif %}
  </div>
  
  <!-- <div class="col-xs-6 col-md-8">
    <h5>
      <a href="{{ group.get_absolute_url }}">{{ group.title }}</a>
      {% if group.email %} <a href="mailto:{{ group.email }}"><i class="fa fa-envelope-o"></i></a>{% endif %}
    </h5>
  </div> -->
  {% endfor %}

{% else %}
  {% for group in profile.group_list_public %}
  <div ng-if="group.logo != ''" class="col-xs-1 pull-right group-logo">
    <!--<a href="{{ group.get_absolute_url }}" ><img src="/uploaded/{{ group.logo }}" alt="{{ group.title }}" /></a> -->
    {% if group.logo %}
    	<a href="{{ group.get_absolute_url }}" ><img src="/uploaded/{{ group.logo }}" alt="{{ group.title }}" /></a>
    {% else %}
    	<a href="{{ group.get_absolute_url }}" ><i class="fa fa-group fa-3x" title="{{ group.title }}"></i></a>
    {% endif %}
  </div>
  <!-- <div class="col-xs-6 col-md-8">
    <h5>
      <a href="{{ group.get_absolute_url }}">{{ group.title }}</a>
      {% if group.email %} <a href="mailto:{{ group.email }}"><i class="fa fa-envelope-o"></i></a>{% endif %}
    </h5>
  </div> -->
  {% endfor %}
{% endif %}
{% endif %}

  <h3>{{ profile.first_name|default:profile.name_long }}</h3>
  <table class="table table-user-profile">
    <tbody>
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Email' %}</td>
        {% if profile.email %}
            <td><a href="mailto:{{ profile.email }}">{{ profile.email }}</a></td>
        {% else %}
            <td>{% trans 'Not provided.' %}</td>
        {% endif %}
      </tr>
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Position' %}</td>
        <td>{{ profile.position | default:_('Not provided.') }}</td>
      </tr>
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Organization'  %}</td>
        <td>{{ profile.organization | default:_('Not provided.') }}</td>
      </tr>
      {% if user.is_authenticated %}
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Location' %}</td>
        <td>{{ profile.location | default:_('Not provided.') }}</td>
      </tr>
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Voice' %}</td>
        {% if profile.voice %}
            <td><a href="tel:{{ profile.voice }}">{{ profile.voice }}</a></td>
        {% else %}
            <td>Not provided.</td>
        {% endif %}
      </tr>
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Fax' %}</td>
        <td>{{ profile.fax | default:_('Not provided.') }}</td>
      </tr>
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Description' %}</td>
        <td>{{ profile.profile | default:_('Not provided.') }}</td>
      </tr>
      {% endif %}
      <tr>
        <td class="table-user-profile-attribute">{% trans 'Keywords' %}</td>
        <td>
            {% if profile.keyword_list %}
                {% for keyword in profile.keyword_list %}
                    <span class="label label-default">{{ keyword }}</span>
                {% endfor %}
            {% else %}
                {% trans 'Not provided' %}
            {% endif %}
        </td>
      </tr>
    </tbody>
  </table>
</div>

<div class="col-xs-12 col-md-3">
  {% if user == profile %}
    <ul class="list-group">
      <li class="list-group-item"><a href="{% url "profile_edit" user.username %}"><i class="fa fa-edit"></i> {% trans "Edit profile" %}</a></li>
      {% if not GEOAXIS_ENABLED %}
      <li class="list-group-item"><a href="{% url "account_password" %}"><i class="fa fa-lock"></i> {% trans "Change password" %}</a></li>
      {% endif %}
    </ul>
    <ul class="list-group">
      <li class="list-group-item"><a href="{% url "layer_upload" %}"><i class="fa fa-cloud-upload"></i> {% trans "Upload new layers" %}</a></li>
      {% if MAPLOOM_ENABLED %}
      <li class="list-group-item"><a href="{% url "new_map" %}"><i class="fa fa-map-marker"></i> {% trans "Create a new map" %}</a></li>
      {% endif %}
      <li class="list-group-item"><a href="{% url "user-activity" profile.username %}"><i class="fa fa-fire"></i> {% trans "My Activities" %}</a></li>
    </ul>
    <ul class="list-group">
      {% if USE_NOTIFICATIONS %}
      <li class="list-group-item"><a href="{% url "notification_notice_settings" %}"><i class="fa fa-bell"></i> {% trans "Notifications" %}</a></li>
      {% endif %}
      {% if perms.announcements.can_manage %}
      <li class="list-group-item"><a href="{% url "announcements_list" %}"><i class="fa fa-bullhorn"></i> {% trans "Announcements" %}</a></li>
      {% endif %}
    </ul>
      {% if user.is_superuser %}
    <ul class="list-group">
      {% if not REGISTRYURL and REGISTRY %}
      <li class="list-group-item"><a href="{% url "services" %}"><i class="fa fa-globe"></i> {% trans "Remote Services" %}</a></li>
      {% endif %}
      {% if INVITES_ENABLED %}
      <li class="list-group-item"><a href="{% url "account_invite_user" %}"><i class="fa fa-edit"></i> {% trans "Invite User" %}</a></li>
      {% endif %}
      <li class="list-group-item"><a href="{{ GEOSERVER_BASE_URL }}"><i class="fa fa-gears"></i> {% trans "GeoServer" %}</a></li>
      {% endif %}
      {% if user.is_staff %}
      <li class="list-group-item"><a href="{% url "admin:index" %}"><i class="fa fa-cog"></i> {% trans "Admin" %}</a></li>
      {% endif %}
    </ul>
    {% if_has_tag if_relationship %}
      {% include "relationships/_manage_connections.html" %}
    {% endif_has_tag %}
  {% else %}
    {% if user.is_superuser %}
    <ul class="list-group">
      <li class="list-group-item"><a href="{% url "profile_edit" profile.username %}"><i class="fa fa-edit"></i> {% trans "Edit profile" %}</a></li>
    </ul>
    {% endif %}
    <ul class="list-group">
      <li class="list-group-item"><a href="{% url "user-activity" profile.username %}"><i class="fa fa-fire"></i> {% trans "User Activities" %}</a></li>
    </ul>
    {% if_has_tag if_relationship %}
      {% include "relationships/_profile_follow.html" %}
    {% endif_has_tag %}
  {% endif %}

  {% if_has_tag if_relationship %}
    {% include "relationships/_list_connections.html" %}
  {% endif_has_tag %}
</div>

<div class="col-md-9">
  <h4>{% trans "Resources" %}</h4>
  <div class="col-md-12">
    {% include "people/_profile_filters.html" %}
  </div>
  <!-- <div class="col-md-12">
    {% include "search/_sort_filters.html" %}
  </div> -->
  <div class="col-md-12">
    {% include 'base/_resourcebase_snippet.html' %}
  </div>
  <div class="col-md-12">
    {% include 'search/_pagination.html' %}
  </div>
</div>

{% endblock %}

{% block extra_script %}
  {% if GEONODE_SECURITY_ENABLED %}
    {% include "_permissions_form_js.html" %}
  {% endif %}
  <script type="text/javascript">
          SEARCH_URL = '{% url 'elastic_search' resourcetype='base' %}?owner__username={{profile.username}}'
  </script>
  {% include 'search/search_scripts.html' %}
  <!-- Avatar code -->
  <script type="text/javascript">

    // if a file gets uploaded
    $('#id_avatar').change(function() {
      $('#avatar_change_btn').prop('disabled', false);
    });

    // if an avatar gets selected
    $('.avatar_img').click(function(e) {
      // deselect any previously selected
      $('.selected_avatar').removeClass('selected_avatar');
      // select this image
      $(this).children().addClass('selected_avatar');
      $('#avatar_change_btn').prop('disabled', false);
      $('#delete_avatar_btn').prop('disabled', false);
    });

    // change avatar
    $('#avatar_change_btn').click(function() {
      // if a file was uploaded, use that
      if (document.getElementById('id_avatar').value != '') {
        $('#avatar_file').trigger('click');
      } else {
        // use selected avatar
        if ($('.selected_avatar').length == 0) {
          console.log('ERROR: Tried to submit avatar change without a selection');
          return;
        }
        // NOTE: This is relying on the name of the selected item's id being of the pattern avatar_{{ avatar_id }}
        var avatar_id = $('.selected_avatar').parent().attr('id').split('avatar_')[1];
        var avatar_choice_id = "#avatar_choice_" + avatar_id;
        $(avatar_choice_id).prop('checked', true);
        $('#avatar_swap').trigger('click');
      }
    });

    // delete avatar
    $('#delete_avatar_btn').click(function() {
        // use selected avatar
        if ($('.selected_avatar').length == 0) {
          console.log('ERROR: Tried to delete an avatar without a selection');
          return;
        }
        // NOTE: This is relying on the name of the selected item's id being of the pattern avatar_{{ avatar_id }}
        var avatar_id = $('.selected_avatar').parent().attr('id').split('avatar_')[1];
        var avatar_delete_id = "#avatar_delete_" + avatar_id;
        $(avatar_delete_id).prop('checked', true);
        $('#avatar_delete').trigger('click');
    });

  </script>
{% endblock %}
