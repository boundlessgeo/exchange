{% extends "site_base.html" %}
{% load i18n %}
{% load theme_tags %}
{% load static from staticfiles %}
{% load base_tags %}

{% block title %} {% trans "Welcome!" %} - {{ block.super }} {% endblock %}

{% block body_class %}home{% endblock %}

{% block middle %}
{{ block.super }}
{% block hero %}
{% get_theme as theme %}
{% if theme.background_logo %}
<div class="jumbotron" style="background: url('{{ theme.background_logo_url }}'); background-size: cover;">
  {% else %}
  <div class="jumbotron" style="background: url('{% static "theme/img/default-background.png" %}'); background-size: cover;">
  {% endif %}
  <div class="container">
  </div>

  <div class="container">
    <h1>Search for Content</h1>
    <div class="search">
      <select id="search_input"><option></option></select>
    </div>
  </div>
</div>
{% endblock %}

{% block mainbody %}
<div class="shim">
</div>

<section id="datasets">
  <div class="container">
    <div class="row">
      <div class="container text-center">
        <h2>Discover the available content</h2>
        {% for category in categories %}
        <div class="col-xs-4 col-sm-2" style="height:200px">
          <a href="/search/?limit=100&offset=0&category={{ category.identifier }}" data-toggle="tooltip" data-placement="auto"
             title="{{ category.description }}">
            <div class="category">
              <i class="fa {{ category.fa_class }} fa-4x"></i>
              <h4>{{ category.gn_description }}</h4>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

<section id="showcase" style="display:none">
  <div class="container">
    <div class="row">
      <h2>Featured Content</h2>
      {% verbatim %}
      <div ng-app="featured">
        <div ng-repeat="item in featured | limitTo:4">
          <div class="col-md-3">
            <a ng-if="item.detail_url.indexOf('/maps/') > -1" href="{{ item.detail_url }}/view">
              <img class="thumbnail" ng-src="/thumbnails{{ item.detail_url }}" />
            </a>
            <a ng-if="item.detail_url.indexOf('/layers/') > -1" href="{% endverbatim %}{% url "new_map" %}?layer={% verbatim %}{{ item.detail_url.substring(8) }}">
              <img class="thumbnail" ng-src="/thumbnails{{ item.detail_url }}" />
            </a>
            <a ng-if="item.detail_url.indexOf('/documents/') > -1" href="{{ item.detail_url }}">
              <img class="thumbnail" ng-src="/thumbnails{{ item.detail_url }}" />
            </a>
            <h5>{{ item.title | limitTo: 20 }}{{item.title.length > 20 ? '...' : ''}}</h5>
          </div>
        </div>
      </div>
      {% endverbatim %}
    </div>
    <p><a href="/search/">Explore all Content</a></p>
  </div>
</section>


{% endblock %}

{% endblock %}

{% block extra_script %}
{% if DEBUG_STATIC %}
<script src="{{ STATIC_URL }}lib/js/angular.js"></script>
{% endif %}
<script type="text/javascript">
  FEATURED_URL = '{% url 'api_dispatch_list' api_name='api' resource_name='featured' %}'
  'use strict';
  (function(){
    var module = angular.module('featured', []);
    module.run(function($http, $rootScope){
      $http.get(FEATURED_URL).then(function(data){
        $rootScope.featured = data.objects || data.data.objects;
        document.getElementById('showcase').style.display = 'block';
      });
    });
  })();
</script>
<script>
  $('[data-toggle="tooltip"]').tooltip();
</script>
<script type="text/javascript">
  $('#search_input').select2({
    ajax: {
      url: '{% url "autocomplete" %}',
      dataType: 'json',
      data: function (params) {
        var query = {
          q: params.term,
        }
        return query;
      },
      processResults: function (data) {
        return {
          results: data.objects
        }
      }
    },
    // TODO: How to get font-awesome search icon back in search bar?
    placeholder: 'Search',
    minimumInputLength: 1,
    tags: true
  });
  $('#search_input').on('select2:select', function(e) {
    var url = '';

    if ('type' in e.params.data) {
      if (e.params.data.type == 'document') {
        url = '/documents/?limit=100&offset=0';
      } else {
        url = '/search/?limit=100&offset=0&type=' + e.params.data.type;
      }
    } else {
      // Assuming layer type?
      url = '/search/?limit=100&offset=0&type=layer';
    }

    url += '&q=' + e.params.data.text;

    // TODO: Is this the correct way to redirect?
    window.location.replace(url);
  });
</script>
{% endblock extra_script %}
